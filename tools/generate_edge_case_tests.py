#!/usr/bin/env python3
"""
Generate Lean test cases for edge cases identified by the loophole scanner.
Creates executable #eval statements to verify exploitable patterns.
"""

import json
from pathlib import Path

def generate_vacuous_truth_tests():
    """Generate tests for vacuous truth patterns."""
    return '''
/-
EDGE CASE TESTS: Vacuous Truth Patterns
Generated by loophole scanner
-/

import Mathlib
import TaxCode.Section831
import TaxCode.Section1297

set_option linter.unusedVariables false
noncomputable section

open Section831 in
/-!
## §831 Vacuous Truth Tests
The specified holder test passes when specifiedHolders is empty.
-/

-- Test 1: Concentrated ownership but NO specified holders
def concentratedButNoSpecified : InsuranceCompany := {
  id := 999
  taxYear := ⟨2024, by omega⟩
  netWrittenPremiums := 1000000
  directWrittenPremiums := 1000000
  investmentIncome := 50000
  underwritingIncome := 200000
  policyHolders := [
    -- ONE policyholder has 100% - FAILS 20% test!
    { id := 1, premiumsPaid := 1000000, isRelatedParty := false }
  ]
  specifiedHolders := []  -- EMPTY - vacuous pass!
  hasElected831b := true
  controlledGroupPremiums := 0
}

-- This SHOULD fail diversification but may pass due to vacuous truth
#eval! meetsNoPolicyholderOver20Test concentratedButNoSpecified  -- false (correctly fails)
#eval! meetsSpecifiedHolderTest concentratedButNoSpecified       -- true (vacuous!)
#eval! meetsDiversificationTest concentratedButNoSpecified       -- true (OR logic!)
#eval! qualifiesFor831b concentratedButNoSpecified               -- true (LOOPHOLE!)

-- Test 2: Empty policyholders list
def emptyPolicyholders : InsuranceCompany := {
  id := 998
  taxYear := ⟨2024, by omega⟩
  netWrittenPremiums := 0
  directWrittenPremiums := 0
  investmentIncome := 100000
  underwritingIncome := 0
  policyHolders := []  -- EMPTY
  specifiedHolders := []
  hasElected831b := true
  controlledGroupPremiums := 0
}

#eval! meetsNoPolicyholderOver20Test emptyPolicyholders  -- true (vacuous!)
#eval! meetsPremiumTest emptyPolicyholders               -- true (0 <= threshold)
#eval! qualifiesFor831b emptyPolicyholders               -- true (LOOPHOLE!)

/-!
## Division by Zero Tests
What happens when denominators are zero?
-/

-- Test 3: Zero total premiums
#eval! policyholderPremiumPercentage
  { id := 1, premiumsPaid := 1000000, isRelatedParty := false }
  emptyPolicyholders  -- Should be 0 (division guard)

/-!
## §1297 PFIC Threshold Tests
Testing the 75% and 50% boundaries.
-/

open Section1297 in
def pficAt74Percent : ForeignCorporation := {
  id := 100
  taxYear := ⟨2024, by omega⟩
  incomeItems := [
    { incomeType := .Dividends, amount := 74, fromRelatedParty := false, relatedPartyActiveIncome := 0 },
    { incomeType := .ActiveBusinessIncome, amount := 26, fromRelatedParty := false, relatedPartyActiveIncome := 0 }
  ]
  assets := []
  subsidiaryOwnership := []
  isCFC := false
  isQualifyingInsuranceCorp := false
  hasUSBankingLicense := false
}

def pficAt75Percent : ForeignCorporation := {
  id := 101
  taxYear := ⟨2024, by omega⟩
  incomeItems := [
    { incomeType := .Dividends, amount := 75, fromRelatedParty := false, relatedPartyActiveIncome := 0 },
    { incomeType := .ActiveBusinessIncome, amount := 25, fromRelatedParty := false, relatedPartyActiveIncome := 0 }
  ]
  assets := []
  subsidiaryOwnership := []
  isCFC := false
  isQualifyingInsuranceCorp := false
  hasUSBankingLicense := false
}

def pficAt76Percent : ForeignCorporation := {
  id := 102
  taxYear := ⟨2024, by omega⟩
  incomeItems := [
    { incomeType := .Dividends, amount := 76, fromRelatedParty := false, relatedPartyActiveIncome := 0 },
    { incomeType := .ActiveBusinessIncome, amount := 24, fromRelatedParty := false, relatedPartyActiveIncome := 0 }
  ]
  assets := []
  subsidiaryOwnership := []
  isCFC := false
  isQualifyingInsuranceCorp := false
  hasUSBankingLicense := false
}

#eval! passiveIncomeRatio pficAt74Percent  -- 74/100 = 0.74
#eval! passiveIncomeRatio pficAt75Percent  -- 75/100 = 0.75
#eval! passiveIncomeRatio pficAt76Percent  -- 76/100 = 0.76

#eval! isPFIC pficAt74Percent  -- false (just under!)
#eval! isPFIC pficAt75Percent  -- true (at threshold, >= means included)
#eval! isPFIC pficAt76Percent  -- true

-- Zero income edge case
def zeroIncomeCorp : ForeignCorporation := {
  id := 103
  taxYear := ⟨2024, by omega⟩
  incomeItems := []
  assets := []
  subsidiaryOwnership := []
  isCFC := false
  isQualifyingInsuranceCorp := false
  hasUSBankingLicense := false
}

#eval! grossIncome zeroIncomeCorp        -- 0
#eval! passiveIncomeRatio zeroIncomeCorp -- 0 (division guard)
#eval! isPFIC zeroIncomeCorp             -- false (0 < 75%)

-- CFC exemption test
def cfcButWouldBePfic : ForeignCorporation := {
  id := 104
  taxYear := ⟨2024, by omega⟩
  incomeItems := [
    { incomeType := .Interest, amount := 100, fromRelatedParty := false, relatedPartyActiveIncome := 0 }
  ]
  assets := []
  subsidiaryOwnership := []
  isCFC := true  -- IS a CFC
  isQualifyingInsuranceCorp := false
  hasUSBankingLicense := false
}

def us10PctShareholder : USPerson := {
  id := 1
  ownershipInCorp := 15 / 100
  isUS10PercentShareholder := true
}

#eval! isPFIC cfcButWouldBePfic  -- true (would be PFIC)
#eval! isPFICForShareholder cfcButWouldBePfic us10PctShareholder  -- false (CFC exempt!)

end
'''

def generate_threshold_boundary_tests():
    """Generate tests at threshold boundaries."""
    return '''
/-!
## Threshold Boundary Tests
Testing behavior at exact threshold values.
-/

import Mathlib
import TaxCode.Section453
import TaxCode.Section951_956

set_option linter.unusedVariables false
noncomputable section

open Section453 in
/-!
## §453 Installment Sale $5M Threshold
-/

def saleAt5M : InstallmentSale := {
  sellingPrice := 5000000  -- Exactly $5M
  adjustedBasis := 1000000
  propertyType := .RealProperty
  saleYear := ⟨2024, by omega⟩
  yearOfSalePayment := 1000000
  subsequentPayments := [(⟨2025, by omega⟩, 2000000), (⟨2026, by omega⟩, 2000000)]
  isRelatedPartySale := false
  buyerId := 1
  sellerId := 2
}

def saleAt5M_plus1 : InstallmentSale := {
  sellingPrice := 5000001  -- $5M + $1
  adjustedBasis := 1000000
  propertyType := .RealProperty
  saleYear := ⟨2024, by omega⟩
  yearOfSalePayment := 1000000
  subsequentPayments := [(⟨2025, by omega⟩, 2000000), (⟨2026, by omega⟩, 2000001)]
  isRelatedPartySale := false
  buyerId := 1
  sellerId := 2
}

def saleAt4_999_999 : InstallmentSale := {
  sellingPrice := 4999999  -- $5M - $1
  adjustedBasis := 1000000
  propertyType := .RealProperty
  saleYear := ⟨2024, by omega⟩
  yearOfSalePayment := 999999
  subsequentPayments := [(⟨2025, by omega⟩, 2000000), (⟨2026, by omega⟩, 2000000)]
  isRelatedPartySale := false
  buyerId := 1
  sellerId := 2
}

#eval! isLargeInstallmentSale saleAt4_999_999  -- false
#eval! isLargeInstallmentSale saleAt5M         -- false (not GREATER than)
#eval! isLargeInstallmentSale saleAt5M_plus1   -- true ($1 over triggers!)

-- Interest charge kicks in at $5M+
-- Cliff effect: $5,000,000 = no interest, $5,000,001 = interest on ALL deferred tax

open Section951_956 in
/-!
## §951A High Tax Exception (18.9% threshold)
-/

-- US corporate rate is 21%, high-tax threshold is 90% of that = 18.9%
#eval! usCorpTaxRate      -- 21/100
#eval! highTaxThreshold   -- 90/100 * 21/100 = 18.9/100

-- Test at boundaries
#eval! qualifiesForHighTaxException (18/100)   -- false (18% < 18.9%)
#eval! qualifiesForHighTaxException (189/1000) -- false (18.9% = 18.9%, need GREATER)
#eval! qualifiesForHighTaxException (19/100)   -- true (19% > 18.9%)
#eval! qualifiesForHighTaxException (20/100)   -- true

-- Ireland at 12.5%
#eval! qualifiesForHighTaxException (125/1000) -- false (12.5% < 18.9%)

-- Japan at 30%
#eval! qualifiesForHighTaxException (30/100)   -- true (30% > 18.9%)

end
'''

def main():
    # Generate test files
    tests_dir = Path("tests/edge_cases")
    tests_dir.mkdir(parents=True, exist_ok=True)

    vacuous_tests = generate_vacuous_truth_tests()
    threshold_tests = generate_threshold_boundary_tests()

    (tests_dir / "VacuousTruthTests.lean").write_text(vacuous_tests)
    (tests_dir / "ThresholdBoundaryTests.lean").write_text(threshold_tests)

    print(f"Generated test files in {tests_dir}/")
    print("  - VacuousTruthTests.lean")
    print("  - ThresholdBoundaryTests.lean")
    print("\nRun with: lake build tests/edge_cases")

    # Also output a summary
    print("\n" + "=" * 60)
    print("EDGE CASES TO VERIFY:")
    print("=" * 60)
    print("""
1. §831 VACUOUS TRUTH:
   - Empty specifiedHolders bypasses diversification test
   - Empty policyHolders passes 20% concentration test

2. §1297 PFIC BOUNDARIES:
   - 74% passive income = NOT PFIC
   - 75% passive income = PFIC (cliff!)
   - Zero income = 0 ratio = NOT PFIC

3. §453 INSTALLMENT SALE:
   - $5,000,000 = NO interest charge
   - $5,000,001 = interest charge on ALL deferred tax

4. §951A HIGH-TAX EXCEPTION:
   - 18.9% foreign rate = NO exception (need GREATER than)
   - 19% foreign rate = exception applies
   - Cliff at 90% of US rate

5. CFC/PFIC INTERACTION:
   - CFC status exempts from PFIC rules
   - 100% passive income CFC = NOT PFIC for US shareholders
""")


if __name__ == "__main__":
    main()
