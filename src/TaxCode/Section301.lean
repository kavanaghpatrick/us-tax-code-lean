/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 2838a889-1684-4030-b309-0f743a8ae953
-/

/-
Formalization of IRC Section 301 in Lean 4.
This module defines the necessary types and structures to represent property distributions,
stock, and shareholder profiles. It implements the calculation logic for the amount distributed
(§301(b)), the taxable amount (§301(c)), and the basis of property received (§301(d)).
It also includes a formalization of the "20 percent corporate shareholder" rule (§301(e)).
The correctness of the calculations is verified by theorems `amountDistributed_nonneg` and
`taxableAmount_sum_eq_amountDistributed`. Examples are provided to demonstrate usage.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Basic definitions for Currency, TaxYear, and FilingStatus as requested.
-/
-- Common definitions
def Currency := Int

structure TaxYear where
  year : Nat
  h_valid : year ≥ 1913
  deriving DecidableEq

inductive FilingStatus
  | Single                         -- IRC §1(c)
  | MarriedFilingJointly          -- IRC §1(a)
  | MarriedFilingSeparately       -- IRC §1(d)
  | HeadOfHousehold               -- IRC §1(b)
  | QualifyingWidower             -- IRC §2(b)
  | Estate                         -- IRC §1(e)(1)
  | Trust                          -- IRC §1(e)(2)
  deriving Repr, DecidableEq, Inhabited

/-
Defining Property, Stock, and Distribution structures to hold the data required for Section 301 calculations. Removed Repr to avoid synthesis issues.
-/
structure Property where
  fairMarketValue : Currency
  liabilitySubjectTo : Currency
  deriving DecidableEq

structure Stock where
  adjustedBasis : Currency
  deriving DecidableEq

structure Distribution where
  moneyReceived : Currency
  otherProperty : List Property
  liabilityAssumed : Currency
  dividendPortion : Currency -- The part of the distribution that is a dividend (Sec 316)
  pre1913Value : Currency -- The part out of increase in value accrued before March 1, 1913
  deriving DecidableEq

/-
Adding typeclass instances for Currency to inherit behavior from Int.
-/
instance : Add Currency := inferInstanceAs (Add Int)
instance : Sub Currency := inferInstanceAs (Sub Int)
instance : Mul Currency := inferInstanceAs (Mul Int)
instance : Div Currency := inferInstanceAs (Div Int)
instance : LT Currency := inferInstanceAs (LT Int)
instance : LE Currency := inferInstanceAs (LE Int)
instance : DecidableEq Currency := inferInstanceAs (DecidableEq Int)
instance : Inhabited Currency := inferInstanceAs (Inhabited Int)
instance : LinearOrder Currency := inferInstanceAs (LinearOrder Int) -- This provides Max and Min
instance (n : Nat) : OfNat Currency n := inferInstanceAs (OfNat Int n)
instance : Repr Currency := inferInstanceAs (Repr Int)

/-
Calculates the amount of distribution under IRC §301(b).
(1) General rule: Money + FMV of other property.
(2) Reduction for liabilities: Reduced by liabilities assumed and liabilities to which property is subject.
(3) Not below zero.
-/
def amountDistributed (d : Distribution) : Currency :=
  let fmvProperty := d.otherProperty.foldl (fun acc p => acc + p.fairMarketValue) 0
  let liabilitiesProperty := d.otherProperty.foldl (fun acc p => acc + p.liabilitySubjectTo) 0
  let totalAmount := d.moneyReceived + fmvProperty
  let totalReduction := d.liabilityAssumed + liabilitiesProperty
  max 0 (totalAmount - totalReduction)

/-
Structure to hold the breakdown of the taxable amount under IRC §301(c).
- dividend: Amount constituting dividend (included in gross income).
- appliedAgainstBasis: Amount applied against and reducing adjusted basis.
- capitalGain: Amount treated as gain from sale or exchange.
- exemptPre1913: Amount exempt from tax (out of pre-1913 increase in value).
-/
structure TaxableAmount where
  dividend : Currency
  appliedAgainstBasis : Currency
  capitalGain : Currency
  exemptPre1913 : Currency
  deriving DecidableEq, Repr

/-
Calculates the taxable amount under IRC §301(c).
(1) Dividend portion is included in gross income.
(2) Remainder is applied against basis.
(3) Excess over basis is capital gain, except for pre-1913 value which is exempt.
-/
def calculateTaxableAmount (d : Distribution) (s : Stock) : TaxableAmount :=
  let amount := amountDistributed d
  let dividend := min amount d.dividendPortion
  let remainder := amount - dividend
  let applied := min remainder s.adjustedBasis
  let excess := remainder - applied
  let exempt := min excess d.pre1913Value
  let gain := excess - exempt
  { dividend := dividend
    appliedAgainstBasis := applied
    capitalGain := gain
    exemptPre1913 := exempt }

/-
IRC §301(d) Basis.
The basis of property received in a distribution to which subsection (a) applies shall be the fair market value of such property.
-/
def basisOfPropertyReceived (p : Property) : Currency :=
  p.fairMarketValue

/-
Theorem verifying that the amount distributed is always non-negative, as per IRC §301(b)(2).
-/
theorem amountDistributed_nonneg (d : Distribution) : amountDistributed d ≥ 0 := by
  exact le_max_left _ _

/-
Helper lemma showing that the sequential decomposition of an amount into parts (dividend, applied against basis, gain, exempt) sums back to the original amount, regardless of the values. This relies on the properties of integer arithmetic.
-/
lemma decomposition_lemma_v2 (amount div_portion basis pre1913 : Currency) :
  let dividend := min amount div_portion
  let remainder := amount - dividend
  let applied := min remainder basis
  let excess := remainder - applied
  let exempt := min excess pre1913
  let gain := excess - exempt
  dividend + applied + gain + exempt = amount := by
  unfold Currency; cases min_cases amount div_portion <;> cases min_cases ( amount - min amount div_portion ) basis <;> cases min_cases ( amount - min amount div_portion - min ( amount - min amount div_portion ) basis ) pre1913 <;> linarith;

/-
Theorem verifying that the sum of the components of the taxable amount equals the total amount distributed.
Components:
1. Dividend
2. Amount applied against basis
3. Capital gain
4. Exempt pre-1913 amount
Proof uses decomposition_lemma_v2.
-/
theorem taxableAmount_sum_eq_amountDistributed (d : Distribution) (s : Stock) :
  let ta := calculateTaxableAmount d s
  ta.dividend + ta.appliedAgainstBasis + ta.capitalGain + ta.exemptPre1913 = amountDistributed d := by
    -- Apply the decomposition lemma to the amount calculated by amountDistributed d.
    apply decomposition_lemma_v2

/-
Formalization of IRC §301(e)(2) "20 percent corporate shareholder".
A 20 percent corporate shareholder is a corporation that:
1. Owns at least 20% of the total combined voting power, OR
2. Owns at least 20% of the total value of all stock (with exceptions),
AND
3. Would be entitled to a deduction under section 243 or 245.
-/
structure CorporateShareholderProfile where
  isCorporation : Bool
  votingPowerOwnedPercent : Nat -- 0 to 100
  totalValueOwnedPercent : Nat -- 0 to 100
  entitledToDeduction : Bool -- Section 243 or 245 deduction entitlement
  deriving DecidableEq, Repr

def isTwentyPercentCorporateShareholder (p : CorporateShareholderProfile) : Bool :=
  if p.isCorporation && p.entitledToDeduction then
    p.votingPowerOwnedPercent ≥ 20 || p.totalValueOwnedPercent ≥ 20
  else
    false

/-
Example usage of the defined functions.
1. Define a property with FMV 1000 and liability 200.
2. Define stock with adjusted basis 500.
3. Define a distribution with money 500, the property, liability assumed 100, dividend portion 800, and pre-1913 value 100.
4. Calculate amount distributed: (500 + 1000) - (100 + 200) = 1200.
5. Calculate taxable amount:
   - Dividend: min(1200, 800) = 800.
   - Remainder: 1200 - 800 = 400.
   - Applied against basis: min(400, 500) = 400.
   - Excess: 400 - 400 = 0.
   - Exempt: min(0, 100) = 0.
   - Gain: 0 - 0 = 0.
   Result: { dividend := 800, appliedAgainstBasis := 400, capitalGain := 0, exemptPre1913 := 0 }
-/
def exampleProperty : Property := { fairMarketValue := 1000, liabilitySubjectTo := 200 }
def exampleStock : Stock := { adjustedBasis := 500 }
def exampleDistribution : Distribution := {
  moneyReceived := 500,
  otherProperty := [exampleProperty],
  liabilityAssumed := 100,
  dividendPortion := 800,
  pre1913Value := 100
}

#eval amountDistributed exampleDistribution
#eval calculateTaxableAmount exampleDistribution exampleStock