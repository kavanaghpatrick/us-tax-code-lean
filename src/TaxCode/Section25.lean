/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 4e64d37a-8267-4bf2-aa8f-1d2502657bba
-/

/-
Formalization of IRC Section 25 (Interest on certain home mortgages).

This module defines the necessary types and structures to represent Mortgage Credit Certificates (MCC)
and implements the calculation of the mortgage interest credit, including the limitation for credit rates
exceeding 20% and the allocation of this limit based on ownership interest.

Key definitions:
- `Currency`: Represents currency in USD cents.
- `MortgageCreditCertificate`: Structure capturing the credit rate and certified indebtedness.
- `calculateCredit`: Main function to compute the allowable credit.

Theorems:
- `credit_nonneg`: Proves that the calculated credit is always non-negative.
- `credit_limit_check`: Verifies that the credit respects the $2,000 limit when applicable.

Examples are provided to demonstrate the calculation.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Basic type definitions for IRC Section 25 formalization including Currency, TaxYear, and FilingStatus.
-/
/-- Currency amount in USD cents (or smallest unit) -/
def Currency := Int

/-- Tax year structure, valid from 1913 onwards -/
structure TaxYear where
  year : Nat
  h_valid : year ≥ 1913
  deriving DecidableEq

/-- Filing status for tax purposes -/
inductive FilingStatus
  | Single                         -- IRC §1(c)
  | MarriedFilingJointly          -- IRC §1(a)
  | MarriedFilingSeparately       -- IRC §1(d)
  | HeadOfHousehold               -- IRC §1(b)
  | QualifyingWidower             -- IRC §2(b)
  | Estate                         -- IRC §1(e)(1)
  | Trust                          -- IRC §1(e)(2)
  deriving Repr, DecidableEq, Inhabited

/-
Checking if Rat is available.
-/
#check Rat

/-
Adding instances for Currency and defining Mortgage Credit Certificate structure.
-/
instance : LinearOrder Currency := inferInstanceAs (LinearOrder Int)
instance : AddCommGroup Currency := inferInstanceAs (AddCommGroup Int)
instance : Ring Currency := inferInstanceAs (Ring Int)
instance {n : Nat} : OfNat Currency n := inferInstanceAs (OfNat Int n)

/-- Mortgage Credit Certificate (MCC) structure -/
structure MortgageCreditCertificate where
  /-- The certificate credit rate specified in the mortgage credit certificate -/
  certificateCreditRate : Rat
  /-- The certified indebtedness amount specified in the mortgage credit certificate -/
  certifiedIndebtednessAmount : Currency
  /-- Validity condition: Rate must be non-negative -/
  h_rate_nonneg : certificateCreditRate ≥ 0
  /-- Validity condition: Indebtedness must be non-negative -/
  h_indebtedness_nonneg : certifiedIndebtednessAmount ≥ 0
  deriving DecidableEq

/-
Checking if Int.floor is available for Rat.
-/
#check (Int.floor : Rat → Int)

/-
Checking availability of Rat.ofInt and Int.cast to Rat.
-/
#check (Rat.ofInt : Int → Rat)
#check (Int.cast : Int → Rat)
#check (1 : Int)
#check ((1 : Int) : Rat)

/-
Defining helper function to round currency, the limit amount constant (200,000 cents), and the main credit calculation function handling the rate limit and ownership allocation with explicit Int.cast for type conversion.
-/
/-- Helper to round Rat to Currency (nearest integer) -/
def roundCurrency (r : Rat) : Currency :=
  Int.floor (r + 1/2)

/-- The maximum credit limit when rate > 20% (IRC §25(a)(2)(A)) - in cents -/
def limitAmount : Currency := 200000

/-- Calculate the mortgage interest credit (IRC §25(a)) -/
def calculateCredit (mcc : MortgageCreditCertificate)
                    (interestPaid : Currency)
                    (ownershipInterest : Rat := 1) : Currency :=
  let interestPaidRat : Rat := Int.cast (interestPaid : Int)
  let tentativeCredit := mcc.certificateCreditRate * interestPaidRat
  let limitAmountRat : Rat := Int.cast (limitAmount : Int)
  let limit : Option Rat := if mcc.certificateCreditRate > (1/5 : Rat) then
                 some (limitAmountRat * ownershipInterest)
               else
                 none
  let allowedCredit := match limit with
    | some l => min tentativeCredit l
    | none => tentativeCredit
  roundCurrency allowedCredit

/-
Theorem stating that the calculated credit is non-negative if the interest paid and ownership interest are non-negative.
-/
theorem credit_nonneg (mcc : MortgageCreditCertificate) (interestPaid : Currency) (ownershipInterest : Rat)
    (h_interest : interestPaid ≥ 0) (h_ownership : ownershipInterest ≥ 0) :
    calculateCredit mcc interestPaid ownershipInterest ≥ 0 := by
  -- Since both the tentative credit and the limit amount are non-negative, their minimum is also non-negative.
  have h_min_nonneg : min (mcc.certificateCreditRate * Int.cast interestPaid) (if mcc.certificateCreditRate > (1/5 : Rat) then Int.cast 200000 * ownershipInterest else 0) ≥ 0 := by
    aesop;
    · positivity;
    · exact mul_nonneg mcc.h_rate_nonneg ( Int.cast_nonneg.mpr h_interest );
  unfold calculateCredit; aesop;
  · exact Int.floor_nonneg.mpr ( by exact add_nonneg ( le_min left ( mul_nonneg ( by norm_num [ limitAmount ] ) h_ownership ) ) ( by norm_num ) );
  · linarith;
  · exact Int.floor_nonneg.2 ( by positivity )

/-
Theorem verifying that if the certificate credit rate exceeds 20%, the calculated credit does not exceed the limit amount ($2,000) adjusted for ownership interest.
-/
theorem credit_limit_check (mcc : MortgageCreditCertificate) (interestPaid : Currency) (ownershipInterest : Rat)
    (h_rate_high : mcc.certificateCreditRate > (1/5 : Rat))
    (h_ownership_nonneg : ownershipInterest ≥ 0)
    (h_interest_nonneg : interestPaid ≥ 0) :
    calculateCredit mcc interestPaid ownershipInterest ≤ roundCurrency ((200000 : Rat) * ownershipInterest) := by
  exact Int.floor_mono ( by aesop )

/-
Defining example Mortgage Credit Certificates with valid proofs for use in evaluations.
-/
/-- Example calculation:
    Credit Rate: 25% (0.25)
    Interest Paid: $10,000 (1,000,000 cents)
    Ownership: 100% (1)
    Expected Credit: Min(25% * 10,000, 2,000) = $2,000
-/
def exampleMCC : MortgageCreditCertificate := {
  certificateCreditRate := 1/4
  certifiedIndebtednessAmount := 20000000 -- $200,000
  h_rate_nonneg := by
    decide +kernel
  h_indebtedness_nonneg := by
    native_decide +revert
}

/-- Example calculation 2:
    Credit Rate: 15% (0.15)
    Interest Paid: $10,000 (1,000,000 cents)
    Ownership: 100% (1)
    Expected Credit: 15% * 10,000 = $1,500 (No limit because rate <= 20%)
-/
def exampleMCC2 : MortgageCreditCertificate := {
  certificateCreditRate := 15/100
  certifiedIndebtednessAmount := 20000000
  h_rate_nonneg := by
    -- Since 15 is positive and 100 is positive, their division is also positive.
    norm_num
  h_indebtedness_nonneg := by
    native_decide +revert
}

/-
Evaluating the credit calculation for the example certificates.
-/
#eval calculateCredit exampleMCC 1000000 1 -- Should be 200000 cents ($2,000)
#eval calculateCredit exampleMCC2 1000000 1 -- Should be 150000 cents ($1,500)