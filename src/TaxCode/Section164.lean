/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 42afb7bd-14b7-4c63-aba6-b8972756cf6b
-/

/-
Formalization of IRC Section 164 (Taxes) in Lean 4.

This module defines the necessary types and structures to represent tax payments, jurisdictions, and taxpayer elections.
It implements the logic for determining the deductibility of various taxes under IRC §164(a) and (b), including:
- State, local, and foreign real property taxes.
- State and local personal property taxes.
- State, local, and foreign income taxes.
- The GST tax imposed on income distributions.
- The election to deduct State and local general sales taxes in lieu of State and local income taxes.
- The exception for taxes paid in connection with the acquisition or disposition of property.

Key definitions:
- `TaxPaymentInfo`: Structure capturing details about a tax payment.
- `isDeductible`: Function determining if a specific tax payment is deductible based on the taxpayer's election.
- `calculateTotalDeduction`: Function calculating the total deductible amount from a list of payments.

The module also includes theorems verifying the correctness of the implementation, such as the effect of the sales tax election and the non-negativity of deductions.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Basic type definitions for IRC Section 164 formalization including Currency, TaxYear, and FilingStatus.
-/
-- Common definitions
def Currency := Int

structure TaxYear where
  year : Nat
  h_valid : year ≥ 1913
  deriving DecidableEq

inductive FilingStatus
  | Single                         -- IRC §1(c)
  | MarriedFilingJointly          -- IRC §1(a)
  | MarriedFilingSeparately       -- IRC §1(d)
  | HeadOfHousehold               -- IRC §1(b)
  | QualifyingWidower             -- IRC §2(b)
  | Estate                         -- IRC §1(e)(1)
  | Trust                          -- IRC §1(e)(2)
  deriving Repr, DecidableEq, Inhabited

/-
Provide necessary instances for Currency and define TaxJurisdiction, TaxType, TaxPayment, and TaxpayerElection.
-/
instance : Repr Currency := inferInstanceAs (Repr Int)
instance : DecidableEq Currency := inferInstanceAs (DecidableEq Int)
instance : Add Currency := inferInstanceAs (Add Int)
instance : Sub Currency := inferInstanceAs (Sub Int)
instance : Mul Currency := inferInstanceAs (Mul Int)
instance : Div Currency := inferInstanceAs (Div Int)
instance : LE Currency := inferInstanceAs (LE Int)
instance : LT Currency := inferInstanceAs (LT Int)
instance : Inhabited Currency := inferInstanceAs (Inhabited Int)
instance (n : Nat) : OfNat Currency n := inferInstanceAs (OfNat Int n)

inductive TaxJurisdiction
  | State
  | Local
  | Foreign
  deriving DecidableEq, Repr

inductive TaxType
  | RealProperty
  | PersonalProperty
  | Income
  | WarProfits
  | ExcessProfits
  | GST
  | GeneralSales
  | Other -- For taxes not described in (1)-(4)
  deriving DecidableEq, Repr

structure TaxPayment where
  amount : Currency
  jurisdiction : TaxJurisdiction
  type : TaxType
  is_business_or_investment : Bool -- "carrying on a trade or business or an activity described in section 212"
  deriving DecidableEq, Repr

structure TaxpayerElection where
  deduct_sales_tax_in_lieu_of_income_tax : Bool
  deriving DecidableEq, Repr

/-
Define TaxPaymentInfo and helper predicates for identifying tax types according to IRC Section 164 definitions.
-/
structure TaxPaymentInfo where
  payment : TaxPayment
  is_ad_valorem : Bool -- For personal property tax definition
  is_annual : Bool -- For personal property tax definition
  is_gst_on_income_distribution : Bool -- For GST definition
  is_general_sales_tax : Bool -- For sales tax election
  is_connection_with_acquisition_or_disposition : Bool
  deriving DecidableEq, Repr

def isStateOrLocal (j : TaxJurisdiction) : Bool :=
  match j with
  | TaxJurisdiction.State => true
  | TaxJurisdiction.Local => true
  | _ => false

def isForeign (j : TaxJurisdiction) : Bool :=
  match j with
  | TaxJurisdiction.Foreign => true
  | _ => false

-- IRC §164(b)(1) Personal property taxes
def isPersonalPropertyTax (info : TaxPaymentInfo) : Bool :=
  info.payment.type == TaxType.PersonalProperty &&
  info.is_ad_valorem &&
  info.is_annual

-- IRC §164(b)(5)(B) General sales tax (simplified check based on flag)
def isGeneralSalesTax (info : TaxPaymentInfo) : Bool :=
  info.payment.type == TaxType.GeneralSales &&
  info.is_general_sales_tax

def isRealPropertyTax (info : TaxPaymentInfo) : Bool :=
  info.payment.type == TaxType.RealProperty

def isIncomeTax (info : TaxPaymentInfo) : Bool :=
  info.payment.type == TaxType.Income ||
  info.payment.type == TaxType.WarProfits ||
  info.payment.type == TaxType.ExcessProfits

def isGST (info : TaxPaymentInfo) : Bool :=
  info.payment.type == TaxType.GST &&
  info.is_gst_on_income_distribution

/-
Implement isDeductible and calculateTotalDeduction functions based on IRC Section 164 logic, handling the election for sales tax and the business expense exception.
-/
def isDeductible (info : TaxPaymentInfo) (election : TaxpayerElection) : Bool :=
  let p := info.payment
  let is_state_local := isStateOrLocal p.jurisdiction
  let is_foreign := isForeign p.jurisdiction
  let is_state_local_income := isIncomeTax info && is_state_local
  let is_foreign_income := isIncomeTax info && is_foreign
  let is_state_local_sales := isGeneralSalesTax info && is_state_local

  -- Determine if the tax is "described in the first sentence" of §164(a) (paragraphs 1-4),
  -- accounting for the election in §164(b)(5).
  let described_in_a_1_4 :=
    if election.deduct_sales_tax_in_lieu_of_income_tax then
      -- If election is made:
      -- (1) Real property (State/local/foreign)
      (isRealPropertyTax info && (is_state_local || is_foreign)) ||
      -- (2) Personal property (State/local)
      (isPersonalPropertyTax info && is_state_local) ||
      -- (3) Foreign income tax (State/local income excluded)
      is_foreign_income ||
      -- (4) GST
      isGST info ||
      -- (5) State/local general sales tax (treated as if in a paragraph)
      is_state_local_sales
    else
      -- Normal rules:
      -- (1) Real property
      (isRealPropertyTax info && (is_state_local || is_foreign)) ||
      -- (2) Personal property
      (isPersonalPropertyTax info && is_state_local) ||
      -- (3) Income tax (State/local/foreign)
      (isIncomeTax info && (is_state_local || is_foreign)) ||
      -- (4) GST
      isGST info

  if described_in_a_1_4 then
    true
  else
    -- "In addition, there shall be allowed as a deduction State and local, and foreign, taxes
    -- not described in the preceding sentence which are paid or accrued within the taxable year
    -- in carrying on a trade or business or an activity described in section 212"
    if p.is_business_or_investment && (is_state_local || is_foreign) then
      -- "Notwithstanding the preceding sentence, any tax (not described in the first sentence...)
      -- which is paid... in connection with an acquisition or disposition of property shall be treated as part of the cost..."
      if info.is_connection_with_acquisition_or_disposition then
        false
      else
        true
    else
      false

def calculateTotalDeduction (payments : List TaxPaymentInfo) (election : TaxpayerElection) : Currency :=
  payments.foldl (fun acc info =>
    if isDeductible info election then
      acc + info.payment.amount
    else
      acc
  ) 0

/-
Theorem: If there are no tax payments, the total deduction is zero.
-/
theorem deduction_zero_if_no_payments (election : TaxpayerElection) :
  calculateTotalDeduction [] election = 0 := by
  rfl

/-
Theorem: If all tax payments are non-negative, the total deduction is non-negative.
-/
theorem deduction_nonnegative (payments : List TaxPaymentInfo) (election : TaxpayerElection)
  (h_pos : ∀ p ∈ payments, p.payment.amount ≥ 0) :
  calculateTotalDeduction payments election ≥ 0 := by
  -- Since each amount is non-negative, the sum of these amounts is non-negative.
  have h_sum_nonneg : ∀ {l : List TaxPaymentInfo}, (∀ p ∈ l, 0 ≤ p.payment.amount) → 0 ≤ l.foldl (fun acc p => if isDeductible p election then acc + p.payment.amount else acc) 0 := by
    intros l hl; induction' l using List.reverseRecOn with p l ih <;> aesop;
    · constructor;
    · exact Int.add_nonneg ih ( hl l ( Or.inr rfl ) );
  exact h_sum_nonneg h_pos

/-
Theorem: The sales tax election allows deducting state/local sales tax instead of state/local income tax.
-/
theorem sales_tax_election_effect :
  let election_income := { deduct_sales_tax_in_lieu_of_income_tax := false : TaxpayerElection }
  let election_sales := { deduct_sales_tax_in_lieu_of_income_tax := true : TaxpayerElection }
  -- If we have a state income tax payment and a state sales tax payment
  ∀ (p_income : TaxPaymentInfo) (p_sales : TaxPaymentInfo),
    isIncomeTax p_income ∧ isStateOrLocal p_income.payment.jurisdiction →
    isGeneralSalesTax p_sales ∧ isStateOrLocal p_sales.payment.jurisdiction →
    -- And they are the only payments
    let payments := [p_income, p_sales]
    -- Then the deduction with income election includes income tax but not sales tax (unless sales tax is business/investment)
    -- And the deduction with sales election includes sales tax but not income tax (unless income tax is business/investment)
    -- Assuming they are not business/investment for simplicity of this property
    ¬p_income.payment.is_business_or_investment →
    ¬p_sales.payment.is_business_or_investment →
    -- Also assume they are not other types of deductible taxes (like real property) to avoid confusion,
    -- though the predicates should be mutually exclusive based on TaxType.
    calculateTotalDeduction payments election_income = p_income.payment.amount ∧
    calculateTotalDeduction payments election_sales = p_sales.payment.amount := by
  aesop;
  · unfold calculateTotalDeduction; aesop;
    · unfold isDeductible at * ; aesop;
      · unfold isRealPropertyTax at h_1; unfold isGeneralSalesTax at left_1; aesop;
      · unfold isGeneralSalesTax at * ; aesop;
        unfold isPersonalPropertyTax at * ; aesop;
      · unfold isGeneralSalesTax at * ; aesop;
        unfold isIncomeTax at * ; aesop;
      · unfold isGST at h_2; aesop;
        unfold isGeneralSalesTax at left_1 ; aesop;
    · unfold isDeductible at *; aesop;
    · exact Int.zero_add _;
    · unfold isDeductible at h_1 ; aesop;
  · unfold calculateTotalDeduction; aesop;
    · unfold isDeductible at * ; aesop;
      · unfold isRealPropertyTax at h_1; unfold isIncomeTax at left; aesop;
      · unfold isIncomeTax at left; unfold isPersonalPropertyTax at h_2; aesop;
      · cases p_income_payment_jurisdiction : p_income.payment.jurisdiction <;> cases p_sales_payment_jurisdiction : p_sales.payment.jurisdiction <;> simp_all +decide;
      · unfold isGST at h_2 ; aesop;
        unfold isIncomeTax at left ; aesop;
      · unfold isGeneralSalesTax at h_2; unfold isIncomeTax at left; aesop;
    · exact Int.zero_add _;
    · unfold isDeductible at * ; aesop;
    · unfold isDeductible at *; aesop;

/-
Theorem: Taxes not listed in §164(a)(1)-(4) that are business expenses but related to acquisition/disposition of property are not deductible under §164.
-/
theorem acquisition_disposition_exception (info : TaxPaymentInfo) (election : TaxpayerElection) :
  -- Assume the tax is NOT one of the specific types in §164(a)(1)-(4)
  ¬isRealPropertyTax info →
  ¬isPersonalPropertyTax info →
  ¬isIncomeTax info →
  ¬isGST info →
  -- And not a sales tax if elected (to be safe, let's just say election is false for simplicity or it's not sales tax)
  ¬(election.deduct_sales_tax_in_lieu_of_income_tax ∧ isGeneralSalesTax info) →
  -- But it IS a State/Local/Foreign tax
  (isStateOrLocal info.payment.jurisdiction ∨ isForeign info.payment.jurisdiction) →
  -- And it IS business/investment
  info.payment.is_business_or_investment →
  -- BUT it is in connection with acquisition or disposition
  info.is_connection_with_acquisition_or_disposition →
  -- Then it is NOT deductible under §164
  ¬isDeductible info election := by
  unfold isDeductible at *; aesop

/-
Examples demonstrating the calculation of deductions with and without the sales tax election.
-/
-- Examples
def example_payment_income : TaxPaymentInfo := {
  payment := {
    amount := 5000,
    jurisdiction := TaxJurisdiction.State,
    type := TaxType.Income,
    is_business_or_investment := false
  },
  is_ad_valorem := false,
  is_annual := false,
  is_gst_on_income_distribution := false,
  is_general_sales_tax := false,
  is_connection_with_acquisition_or_disposition := false
}

def example_payment_sales : TaxPaymentInfo := {
  payment := {
    amount := 3000,
    jurisdiction := TaxJurisdiction.State,
    type := TaxType.GeneralSales,
    is_business_or_investment := false
  },
  is_ad_valorem := false,
  is_annual := false,
  is_gst_on_income_distribution := false,
  is_general_sales_tax := true,
  is_connection_with_acquisition_or_disposition := false
}

def example_payment_real_prop : TaxPaymentInfo := {
  payment := {
    amount := 4000,
    jurisdiction := TaxJurisdiction.Local,
    type := TaxType.RealProperty,
    is_business_or_investment := false
  },
  is_ad_valorem := true,
  is_annual := true,
  is_gst_on_income_distribution := false,
  is_general_sales_tax := false,
  is_connection_with_acquisition_or_disposition := false
}

def example_payments := [example_payment_income, example_payment_sales, example_payment_real_prop]

def election_no_sales := { deduct_sales_tax_in_lieu_of_income_tax := false : TaxpayerElection }
def election_yes_sales := { deduct_sales_tax_in_lieu_of_income_tax := true : TaxpayerElection }

#eval calculateTotalDeduction example_payments election_no_sales
-- Expected: 5000 (Income) + 4000 (Real Prop) = 9000. Sales tax (3000) ignored.

#eval calculateTotalDeduction example_payments election_yes_sales
-- Expected: 3000 (Sales) + 4000 (Real Prop) = 7000. Income tax (5000) ignored.