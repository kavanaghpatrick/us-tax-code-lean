/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 5454257f-3ee2-4cd8-b9df-78b6029e3bd0
-/

/-
Formalization of IRC Section 2501 (Imposition of Gift Tax).
This module defines the necessary data structures (Donor, Property, Transfer, etc.)
and implements the logic for determining taxable transfers and their values,
including specific rules for non-residents, expatriates, and foreign corporations.
It includes theorems verifying the logic against the legal text and examples.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

-- Common definitions
def Currency := Int

structure TaxYear where
  year : Nat
  h_valid : year ≥ 1913
  deriving DecidableEq

inductive FilingStatus
  | Single
  | MarriedFilingJointly
  | MarriedFilingSeparately
  | HeadOfHousehold
  | QualifyingWidower
  deriving DecidableEq, Repr

/-
Add Repr instance for TaxYear to support #eval.
-/
instance : Repr TaxYear where
  reprPrec t _ := repr t.year

/-
Define Repr instance for Currency by inferring it as Repr Int.
-/
instance : Repr Currency := inferInstanceAs (Repr Int)

/-
Definitions of PropertyType, Location, ForeignCorpInfo, Property, Donor, and Transfer structures to model the entities in IRC §2501.
-/
inductive PropertyType
  | Tangible
  | Intangible
  deriving DecidableEq, Repr

inductive Location
  | UnitedStates
  | Foreign
  deriving DecidableEq, Repr

structure ForeignCorpInfo where
  isForeignCorp : Bool
  donorVotingPower : Nat -- Percentage 0-100
  donorTotalValue : Nat -- Percentage 0-100
  usAssetValue : Currency
  totalAssetValue : Currency
  deriving DecidableEq, Repr

structure Property where
  propType : PropertyType
  location : Location
  value : Currency
  foreignCorpInfo : Option ForeignCorpInfo -- If it's stock
  deriving DecidableEq, Repr

structure Donor where
  isUSCitizen : Bool
  isUSResident : Bool
  isResidentOfPossession : Bool
  acquiredCitizenshipSolelyByPossession : Bool -- For §2501(b) and (c)
  isExpatriate : Bool -- For §877(b)
  deriving DecidableEq, Repr

structure Transfer where
  donor : Donor
  property : Property
  date : TaxYear
  toPoliticalOrg : Bool -- §2501(a)(4)
  toExemptOrg : Bool -- §2501(a)(6)
  deriving DecidableEq, Repr

/-
Add arithmetic instances for Currency so it behaves like Int.
-/
instance : Add Currency := inferInstanceAs (Add Int)
instance : Sub Currency := inferInstanceAs (Sub Int)
instance : Mul Currency := inferInstanceAs (Mul Int)
instance : Div Currency := inferInstanceAs (Div Int)
instance : LE Currency := inferInstanceAs (LE Int)
instance : LT Currency := inferInstanceAs (LT Int)
instance : DecidableEq Currency := inferInstanceAs (DecidableEq Int)
instance (n : Nat) [OfNat Int n] : OfNat Currency n := inferInstanceAs (OfNat Int n)
instance : Inhabited Currency := inferInstanceAs (Inhabited Int)

/-
Helper functions for donor status (IRC §2501(b), (c)) and foreign corporation rules (IRC §2501(a)(5)(B), (C)).
-/
def isTreatedAsCitizen (d : Donor) : Bool :=
  d.isUSCitizen && (!d.isResidentOfPossession || !d.acquiredCitizenshipSolelyByPossession)

def isTreatedAsNonresidentNotCitizen (d : Donor) : Bool :=
  (!d.isUSCitizen && !d.isUSResident) ||
  (d.isUSCitizen && d.isResidentOfPossession && d.acquiredCitizenshipSolelyByPossession)

def isForeignCorpDescribed (info : ForeignCorpInfo) : Bool :=
  info.isForeignCorp &&
  info.donorVotingPower >= 10 &&
  (info.donorVotingPower > 50 || info.donorTotalValue > 50)

def getUSAssetValue (info : ForeignCorpInfo) (fairMarketValue : Currency) : Currency :=
  if info.totalAssetValue == 0 then 0 else
  (fairMarketValue * info.usAssetValue) / info.totalAssetValue

/-
Implement isTaxableTransfer and getTaxableValue based on IRC §2501 rules.
-/
def isTaxableTransfer (t : Transfer) : Bool :=
  if t.toPoliticalOrg || t.toExemptOrg then false
  else if isTreatedAsCitizen t.donor || t.donor.isUSResident then true
  else -- Nonresident not citizen
    if t.property.propType == PropertyType.Intangible then
      if t.donor.isExpatriate then true -- §2501(a)(3) Exception
      else false -- §2501(a)(2) General exception for intangibles
    else
      t.property.location == Location.UnitedStates -- Tangible property taxable only if US situs (§2511)

def getTaxableValue (t : Transfer) : Currency :=
  if !isTaxableTransfer t then 0
  else
    match t.property.foreignCorpInfo with
    | some info =>
      if t.donor.isExpatriate && isForeignCorpDescribed info then
        getUSAssetValue info t.property.value -- §2501(a)(5)
      else
        t.property.value
    | none => t.property.value

/-
Theorem: Transfers by citizens or residents are taxable (unless to political/exempt orgs).
-/
-- IRC §2501(a)(1)
theorem citizen_resident_taxable (t : Transfer)
  (h_status : isTreatedAsCitizen t.donor = true ∨ t.donor.isUSResident = true)
  (h_not_political : t.toPoliticalOrg = false)
  (h_not_exempt : t.toExemptOrg = false) :
  isTaxableTransfer t = true := by
    unfold isTaxableTransfer; aesop

/-
Theorem: Transfers of intangible property by non-residents (who are not expatriates) are not taxable. Requires donor not to be a US resident.
-/
-- IRC §2501(a)(2)
theorem nonresident_intangible_exempt (t : Transfer)
  (h_nonresident : isTreatedAsNonresidentNotCitizen t.donor = true)
  (h_not_resident : t.donor.isUSResident = false) -- Required for consistency with "treated as nonresident"
  (h_intangible : t.property.propType = PropertyType.Intangible)
  (h_not_expatriate : t.donor.isExpatriate = false)
  (h_not_political : t.toPoliticalOrg = false)
  (h_not_exempt : t.toExemptOrg = false) :
  isTaxableTransfer t = false := by
    unfold isTaxableTransfer;
    unfold isTreatedAsCitizen at *; unfold isTreatedAsNonresidentNotCitizen at *; aesop;

/-
Theorem: Transfers of intangible property by expatriates are taxable (exception to the exception).
-/
-- IRC §2501(a)(3)
theorem expatriate_intangible_taxable (t : Transfer)
  (h_nonresident : isTreatedAsNonresidentNotCitizen t.donor = true)
  (h_intangible : t.property.propType = PropertyType.Intangible)
  (h_expatriate : t.donor.isExpatriate = true)
  (h_not_political : t.toPoliticalOrg = false)
  (h_not_exempt : t.toExemptOrg = false) :
  isTaxableTransfer t = true := by
    unfold isTaxableTransfer; aesop;

/-
Theorem: Transfers to political organizations are not taxable.
-/
-- IRC §2501(a)(4)
theorem political_org_exempt (t : Transfer)
  (h_political : t.toPoliticalOrg = true) :
  isTaxableTransfer t = false := by
    unfold isTaxableTransfer; aesop;

/-
Theorem: Transfers to certain exempt organizations are not taxable.
-/
-- IRC §2501(a)(6)
theorem exempt_org_exempt (t : Transfer)
  (h_exempt : t.toExemptOrg = true) :
  isTaxableTransfer t = false := by
    -- If an entity is either a political organization or an exempt organization, then the transfer is not taxable.
    simp [isTaxableTransfer, h_exempt]

/-
Theorem: For expatriates transferring stock in a described foreign corporation, the taxable value is the U.S. asset value.
-/
-- IRC §2501(a)(5)
theorem expatriate_stock_valuation (t : Transfer)
  (info : ForeignCorpInfo)
  (h_stock : t.property.foreignCorpInfo = some info)
  (h_expatriate : t.donor.isExpatriate = true)
  (h_described : isForeignCorpDescribed info = true)
  (h_taxable : isTaxableTransfer t = true) :
  getTaxableValue t = getUSAssetValue info t.property.value := by
    unfold getTaxableValue; aesop

/-
Examples to demonstrate the functionality of the formalized code.
-/
-- Examples
def exampleTaxYear : TaxYear := { year := 2023, h_valid := by simp }

def exampleDonorCitizen : Donor := {
  isUSCitizen := true,
  isUSResident := true,
  isResidentOfPossession := false,
  acquiredCitizenshipSolelyByPossession := false,
  isExpatriate := false
}

def exampleDonorNonresident : Donor := {
  isUSCitizen := false,
  isUSResident := false,
  isResidentOfPossession := false,
  acquiredCitizenshipSolelyByPossession := false,
  isExpatriate := false
}

def examplePropertyTangible : Property := {
  propType := PropertyType.Tangible,
  location := Location.UnitedStates,
  value := 10000,
  foreignCorpInfo := none
}

def examplePropertyIntangible : Property := {
  propType := PropertyType.Intangible,
  location := Location.UnitedStates,
  value := 5000,
  foreignCorpInfo := none
}

def exampleTransferCitizen : Transfer := {
  donor := exampleDonorCitizen,
  property := examplePropertyTangible,
  date := exampleTaxYear,
  toPoliticalOrg := false,
  toExemptOrg := false
}

def exampleTransferNonresidentIntangible : Transfer := {
  donor := exampleDonorNonresident,
  property := examplePropertyIntangible,
  date := exampleTaxYear,
  toPoliticalOrg := false,
  toExemptOrg := false
}

#eval isTaxableTransfer exampleTransferCitizen -- Should be true
#eval isTaxableTransfer exampleTransferNonresidentIntangible -- Should be false

-- Test case for situs bug fix: Nonresident gifting foreign tangible property should NOT be taxable
def examplePropertyForeignTangible : Property := {
  propType := PropertyType.Tangible,
  location := Location.Foreign,
  value := 100000,
  foreignCorpInfo := none
}

def exampleTransferNonresidentForeignTangible : Transfer := {
  donor := exampleDonorNonresident,
  property := examplePropertyForeignTangible,
  date := exampleTaxYear,
  toPoliticalOrg := false,
  toExemptOrg := false
}

#eval isTaxableTransfer exampleTransferNonresidentForeignTangible -- Should be FALSE (foreign situs)