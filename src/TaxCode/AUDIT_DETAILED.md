# Formal Verification Audit: IRC Sections 108, 121, and 301
## Lean 4 Code Generated by Aristotle

**Audit Date:** December 12, 2025
**Lean Version:** v4.24.0
**Mathlib Version:** f897ebcf72cd16f89ab4577d0c826cd14afaafc7
**Auditor:** Claude Opus 4.5

---

## Executive Summary

This audit evaluates the formal verification of three Internal Revenue Code sections implemented in Lean 4. All three sections contain **zero `sorry` statements**, meaning all theorems are fully proven. The implementations demonstrate strong mathematical rigor and correctness for the core provisions they model.

**Overall Assessment:**
- **Section 301** (Distributions of property): EXCELLENT - Accept for production use
- **Section 121** (Principal residence exclusion): GOOD - Minor fixes recommended
- **Section 108** (Discharge of indebtedness): GOOD - Moderate fixes recommended

---

## Section 108: Income from Discharge of Indebtedness

**File:** `/Users/patrickkavanagh/aristotle_legal/src/TaxCode/Section108.lean`
**Score:** 7/10
**Status:** GOOD
**Recommendation:** FIX (enhance for production completeness)

### Completeness Analysis

#### ✅ What's Covered
1. **§108(a)(1)(A)-(E)** - All five discharge categories are enumerated:
   - Title 11 bankruptcy cases
   - Insolvency
   - Qualified farm indebtedness
   - Qualified real property business indebtedness
   - Qualified principal residence indebtedness

2. **§108(a)(3)** - Insolvency limitation correctly implemented:
   ```lean
   | DischargeCategory.Insolvency => min d.amount s.insolvency_amount
   ```

3. **§108(b)(2)** - Complete attribute reduction waterfall with correct ordering:
   - NOL ($1 for $1)
   - General business credit (33⅓¢ per $1 = divide by 3)
   - Minimum tax credit (33⅓¢ per $1)
   - Capital loss carryovers ($1 for $1)
   - Basis reduction ($1 for $1)
   - Passive activity losses ($1 for $1)
   - Foreign tax credit (33⅓¢ per $1)

4. **Credit Reduction Formula** - Mathematically correct:
   ```lean
   let gbc_red := min s.general_business_credit (rem / 3)
   let used_gbc := gbc_red * 3
   ```

#### ❌ What's Missing

1. **§108(b)(5)** - Basis Reduction Election
   - Statute allows electing to reduce depreciable property basis FIRST
   - Code only implements the default ordering
   - **Impact:** Cannot model taxpayers who prefer to preserve NOLs/credits

2. **§108(c)** - Qualified Principal Residence Indebtedness Details
   - Missing: Acquisition indebtedness limitation ($750,000 modified limit)
   - Missing: Rules for refinancing and tracing
   - Simplified: `written_arrangement_before_2026` is just a boolean
   - **Impact:** Cannot verify whether debt actually qualifies

3. **§108(d)(7)** - Real Property Business Election
   - Code lacks election mechanics and qualification tests
   - Missing: Debt must be incurred/assumed in connection with real property
   - Missing: Debt must be secured by such property
   - **Impact:** Cannot verify proper qualification for this category

4. **§108(e)** - Entity-Specific Rules
   - Missing: S corporation shareholder rules
   - Missing: Partnership partner rules
   - Missing: C corporation special provisions
   - **Impact:** Cannot handle passthrough entity scenarios

5. **§108(g)** - Special Rules for Principal Residence
   - Missing: Coordination with §121 exclusion
   - Missing: Rules for when both §121 and §108 might apply
   - **Impact:** Cannot model overlapping exclusions

### Correctness Analysis

#### ✅ Proven Theorems

1. **title11_exclusion_full**: Title 11 discharges exclude entire amount ✓
2. **insolvency_exclusion_limit**: Insolvency exclusion ≤ insolvency amount ✓
3. **title11_precedence**: Title 11 takes precedence ✓
4. **nol_reduction_correct**: NOL reduces correctly ✓
5. **gbc_reduction_correct**: GBC reduces at 33⅓¢ rate ✓
6. **attributes_untouched_if_fully_absorbed_by_nol**: If NOL absorbs all, other attributes unchanged ✓

All proofs complete - no `sorry` statements.

#### ⚠️ Logical Issues

1. **QualifiedRealPropertyBusiness Logic:**
   ```lean
   | DischargeCategory.QualifiedRealPropertyBusiness =>
     if s.is_c_corporation then
       min d.amount s.insolvency_amount
     else
       d.amount
   ```
   This is **backwards**. Per §108(a)(1)(D):
   - C corporations: Always excluded (no insolvency test)
   - Non-C corporations: Must elect, and limited to basis of qualified property
   - Code incorrectly limits C corps and not non-C corps

2. **QualifiedPrincipalResidence Oversimplified:**
   ```lean
   let is_valid_date := d.year.year < 2026 || d.written_arrangement_before_2026
   ```
   The actual statute requires:
   - Acquisition indebtedness incurred to acquire, construct, or substantially improve
   - Secured by the residence
   - Limited to $750,000 ($1M pre-TCJA)
   - Discharge must occur before Jan 1, 2026 OR under written agreement before that date

### Examples Verification

```lean
def exampleDischarge : DischargeIndebtedness := {
  amount := 10000,
  category := DischargeCategory.Insolvency,
  year := exampleYear
}

def exampleStatus : TaxpayerStatus := {
  insolvency_amount := 4000,
  ...
}

#eval excludedAmount exampleDischarge exampleStatus exampleElections
-- Output: 4000 ✓ (min of 10000 and 4000)
```

Arithmetic verified as correct for implemented provisions.

---

## Section 121: Exclusion of Gain from Sale of Principal Residence

**File:** `/Users/patrickkavanagh/aristotle_legal/src/TaxCode/Section121.lean`
**Score:** 8/10
**Status:** GOOD
**Recommendation:** FIX (add unforeseen circumstances provisions)

### Completeness Analysis

#### ✅ What's Covered

1. **§121(a)** - Basic Exclusion Requirements
   - Ownership test: 2 years out of 5 years ✓
   - Use test: 2 years out of 5 years ✓
   - Lookback period correctly set to 1825 days (5 years)
   - 730 days threshold (2 years) correctly applied

2. **§121(b)(1)-(2)** - Exclusion Limits
   ```lean
   def limitSingle : Currency := 250000
   def limitJoint : Currency := 500000
   ```
   - Single filers: $250,000 ✓
   - Joint filers: $500,000 (if requirements met) ✓

3. **§121(b)(2)(A)** - Joint Return Requirements
   ```lean
   def checkJointReturnRequirements (t1 t2 : Taxpayer) (saleDate : Day) : Bool :=
     let cond_i := own1 || own2      -- Either spouse owned
     let cond_ii := use1 && use2      -- Both spouses used
     let cond_iii := !freq1 && !freq2 -- Neither used exclusion recently
   ```
   Correctly implements three-part test ✓

4. **§121(b)(3)** - Frequency Limitation
   ```lean
   def checkFrequencyLimit (saleDate : Day) (priorExclusions : List Day) : Bool :=
     let twoYearsAgo := saleDate - 730
     priorExclusions.any (fun d => d > twoYearsAgo && d < saleDate)
   ```
   Correctly prevents exclusion if used within prior 2 years ✓

5. **§121(b)(4)** - Surviving Spouse Rule
   ```lean
   | FilingStatus.QualifyingWidower =>
     if saleDate <= deathDate + 730 then
       match t2 with
       | some spouse =>
          if checkJointReturnRequirements t1 spouse deathDate then limitJoint
   ```
   Allows $500,000 if sale within 2 years of spouse's death ✓

6. **§121(b)(5)** - Nonqualified Use Provisions
   ```lean
   def calculateNonqualifiedUseRatio (history : PropertyHistory) (saleDate : Day) : Rat :=
     -- Post-2009 nonqualified use periods
     -- Minus exception zone (last 5 years after final use)
   ```
   Complex but **correctly implemented**:
   - Only counts nonqualified use after Jan 1, 2009 ✓
   - Excludes the last 5 years after final use as principal residence ✓
   - Computes ratio: nonqualified days / total ownership days ✓
   - Allocates gain proportionally ✓

#### ❌ What's Missing

1. **§121(c)** - Reduced Exclusion for Unforeseen Circumstances
   - Code comments: "TODO"
   - Missing: Health circumstances
   - Missing: Employment changes (>50 miles)
   - Missing: Unforeseen circumstances as defined by Treasury regs
   - **Impact:** Cannot model partial exclusions for those not meeting full 2-year requirement

2. **§121(d)(5)-(6)** - Special Rules for Joint Returns
   - Missing: Treatment when only one spouse meets requirements
   - Missing: Detailed attribution rules for periods before/after marriage
   - **Impact:** May not correctly handle all joint filing scenarios

3. **§121(d)(10)** - Property Acquired in Like-Kind Exchange
   - Missing: Special 5-year rule for §1031 exchanges
   - **Impact:** Cannot model sales of property acquired in §1031 exchange

4. **§121(d)(11)** - Divorced/Separated Spouse Rules
   - Missing: Treatment of ownership/use by spouse or former spouse
   - Missing: Transfer incident to divorce provisions
   - **Impact:** Cannot model post-divorce sales

### Correctness Analysis

#### ✅ Proven Theorems

1. **exclusion_limit_nonneg**: Exclusion limit is always ≥ 0 ✓
2. **excluded_gain_le_limit**: Excluded gain never exceeds statutory limit ✓
3. **excluded_gain_le_total_gain**: Excluded gain never exceeds actual gain ✓

All proofs are complete and use sophisticated tactics including:
- Case analysis on filing status
- Rational number arithmetic
- List operations (sum, fold)
- Linear arithmetic (linarith, omega)

#### ✅ Mathematical Soundness

The nonqualified use calculation is particularly sophisticated:

```lean
let totalNQDays := (history.nonqualifiedUsePeriods.map (fun p =>
  -- 1. Intersect with post-2009
  let start1 := max p.start DATE_2009_01_01
  let finish1 := p.finish
  if start1 >= finish1 then 0 else
  let len1 := finish1 - start1

  -- 2. Subtract intersection with exceptionZone
  let deduction := ...
  len1 - deduction
)).sum

Rat.divInt totalNQDays totalOwnershipDays
```

This correctly:
1. Filters to post-2009 periods only
2. Excludes the final 5-year exception
3. Computes ratio as rational number
4. Uses floor function to convert to currency

**Verified:** The mathematical logic matches IRC §121(b)(5) requirements.

### Time Period Logic Verification

```lean
def intersection (i1 i2 : TimePeriod) : Option TimePeriod :=
  let start := max i1.start i2.start
  let finish := min i1.finish i2.finish
  if h : start ≤ finish then
    some ⟨start, finish, h⟩
  else
    none
```

This is **mathematically correct** interval arithmetic with proof of `start ≤ finish`.

---

## Section 301: Distributions of Property

**File:** `/Users/patrickkavanagh/aristotle_legal/src/TaxCode/Section301.lean`
**Score:** 9/10
**Status:** EXCELLENT
**Recommendation:** ACCEPT (production ready for core provisions)

### Completeness Analysis

#### ✅ What's Covered (Comprehensive)

1. **§301(b)(1)** - Amount Distributed Calculation
   ```lean
   def amountDistributed (d : Distribution) : Currency :=
     let fmvProperty := d.otherProperty.foldl (fun acc p => acc + p.fairMarketValue) 0
     let liabilitiesProperty := d.otherProperty.foldl (fun acc p => acc + p.liabilitySubjectTo) 0
     let totalAmount := d.moneyReceived + fmvProperty
     let totalReduction := d.liabilityAssumed + liabilitiesProperty
     max 0 (totalAmount - totalReduction)
   ```
   Correctly implements: Money + FMV - Liabilities ✓

2. **§301(b)(2)(A)-(B)** - Liability Reductions
   - Liabilities assumed by shareholder ✓
   - Liabilities subject to which property is subject ✓
   - Reduction cannot go below zero ✓

3. **§301(c)(1)** - Dividend Portion
   ```lean
   let dividend := min amount d.dividendPortion
   ```
   Included in gross income to extent it's a dividend ✓

4. **§301(c)(2)** - Applied Against Basis
   ```lean
   let applied := min remainder s.adjustedBasis
   ```
   Remainder reduces stock basis ✓

5. **§301(c)(3)(A)** - Capital Gain
   ```lean
   let gain := excess - exempt
   ```
   Excess over basis is capital gain ✓

6. **§301(c)(3)(B)** - Pre-1913 Exception
   ```lean
   let exempt := min excess d.pre1913Value
   ```
   Historic provision for pre-March 1, 1913 appreciation ✓

7. **§301(d)** - Basis of Property Received
   ```lean
   def basisOfPropertyReceived (p : Property) : Currency :=
     p.fairMarketValue
   ```
   FMV basis rule correctly implemented ✓

8. **§301(e)(2)** - 20% Corporate Shareholder Definition
   ```lean
   def isTwentyPercentCorporateShareholder (p : CorporateShareholderProfile) : Bool :=
     if p.isCorporation && p.entitledToDeduction then
       p.votingPowerOwnedPercent ≥ 20 || p.totalValueOwnedPercent ≥ 20
     else
       false
   ```
   Correctly captures:
   - Must be a corporation ✓
   - 20% voting power OR 20% value ✓
   - Must be entitled to §243 or §245 deduction ✓

#### ❌ What's Missing (Minor)

1. **§301(e)(1)** - Earnings and Profits Impact
   - Missing: How §312(k) and §312(n) exclusions affect E&P for 20% corporate shareholders
   - Code defines the test but doesn't model the E&P calculation difference
   - **Impact:** Limited - most users only need distribution characterization

2. **§318** - Constructive Ownership
   - Referenced in §301(e)(2) for determining 20% ownership
   - Code assumes direct ownership only
   - **Impact:** May undercount ownership in family/entity attribution scenarios

3. **§312** - Earnings and Profits
   - Code takes `dividendPortion` as input but doesn't compute it
   - Missing: How distributions affect E&P
   - **Impact:** Users must calculate E&P externally

### Correctness Analysis

#### ✅ Proven Theorems

1. **amountDistributed_nonneg**: Amount distributed is always ≥ 0 ✓
   ```lean
   theorem amountDistributed_nonneg (d : Distribution) : amountDistributed d ≥ 0 := by
     exact le_max_left _ _
   ```

2. **taxableAmount_sum_eq_amountDistributed**: Components sum to total ✓
   ```lean
   theorem taxableAmount_sum_eq_amountDistributed (d : Distribution) (s : Stock) :
     let ta := calculateTaxableAmount d s
     ta.dividend + ta.appliedAgainstBasis + ta.capitalGain + ta.exemptPre1913 = amountDistributed d
   ```

3. **decomposition_lemma_v2**: Mathematical proof of decomposition ✓
   ```lean
   lemma decomposition_lemma_v2 (amount div_portion basis pre1913 : Currency) :
     let dividend := min amount div_portion
     let remainder := amount - dividend
     let applied := min remainder basis
     let excess := remainder - applied
     let exempt := min excess pre1913
     let gain := excess - exempt
     dividend + applied + gain + exempt = amount
   ```

This lemma is particularly important - it proves that the four-way split of the distribution amount is mathematically complete (no amount lost or double-counted).

#### ✅ Example Verification

```lean
def exampleProperty : Property := { fairMarketValue := 1000, liabilitySubjectTo := 200 }
def exampleStock : Stock := { adjustedBasis := 500 }
def exampleDistribution : Distribution := {
  moneyReceived := 500,
  otherProperty := [exampleProperty],
  liabilityAssumed := 100,
  dividendPortion := 800,
  pre1913Value := 100
}

#eval amountDistributed exampleDistribution
-- Expected: (500 + 1000) - (100 + 200) = 1200 ✓

#eval calculateTaxableAmount exampleDistribution exampleStock
-- Expected: { dividend := 800, appliedAgainstBasis := 400, capitalGain := 0, exemptPre1913 := 0 }
-- Calculation:
--   Amount distributed: 1200
--   Dividend: min(1200, 800) = 800
--   Remainder: 1200 - 800 = 400
--   Applied to basis: min(400, 500) = 400
--   Excess: 400 - 400 = 0
--   Capital gain: 0
-- ✓ CORRECT
```

Manual verification confirms the example produces correct results.

---

## Cross-Cutting Analysis

### Type Safety

All three sections use strong typing:

```lean
structure TaxYear where
  year : Nat
  h_valid : year ≥ 1913
  deriving DecidableEq
```

This ensures tax years before 1913 (when income tax was enacted) cannot be represented - a meaningful domain constraint.

### Currency Handling

```lean
def Currency := Int
instance : LinearOrder Currency := inferInstanceAs (LinearOrder Int)
instance : AddGroup Currency := inferInstanceAs (AddGroup Int)
```

Using `Int` (arbitrary precision integers) rather than floating point avoids rounding errors. This is **correct** for tax calculations where exact dollar amounts matter.

### Proof Techniques

The code employs sophisticated proof techniques:
- **Simplification**: `simp`, `unfold`, `norm_num`
- **Case analysis**: `cases`, `split_ifs`
- **Linear arithmetic**: `linarith`, `omega`
- **Automated reasoning**: `aesop`, `decide`
- **Manual proofs**: `by_contra`, `apply`, `exact`

All proofs terminate successfully - no `sorry` statements in any file.

### Documentation Quality

Each file includes:
- Module-level documentation explaining the formalization
- Key components listed
- Purpose and legal citation
- Examples with expected outputs
- Comments explaining complex logic

This is **excellent** practice for formal verification.

---

## Recommendations

### Section 108 - Required Fixes

**Priority 1: Fix QualifiedRealPropertyBusiness logic**
```lean
-- CURRENT (WRONG):
| DischargeCategory.QualifiedRealPropertyBusiness =>
  if s.is_c_corporation then
    min d.amount s.insolvency_amount
  else
    d.amount

-- SHOULD BE:
| DischargeCategory.QualifiedRealPropertyBusiness =>
  if s.is_c_corporation then
    d.amount  -- C corps: no limitation
  else
    min d.amount s.qualified_property_basis  -- Non-C: limited to basis
```

**Priority 2: Add basis reduction election**
```lean
structure TaxpayerElections where
  apply_insolvency_over_principal_residence : Bool := false
  reduce_basis_first : Bool := false  -- NEW: §108(b)(5) election
```

**Priority 3: Enhance QualifiedPrincipalResidence**
Add fields to model actual acquisition indebtedness:
```lean
structure DischargeIndebtedness where
  -- ... existing fields ...
  acquisition_debt_amount : Currency  -- NEW
  secured_by_residence : Bool  -- NEW
```

### Section 121 - Recommended Enhancements

**Priority 1: Implement reduced exclusion (§121(c))**
```lean
structure UnforeseenCircumstances where
  health_reason : Bool
  employment_change : Bool
  distance_to_new_job : Currency  -- in miles
  other_unforeseen : Bool

def calculateReducedExclusion (circumstances : UnforeseenCircumstances)
    (daysOwned : Int) (limit : Currency) : Currency := ...
```

**Priority 2: Add divorced spouse rules**
Document that current implementation assumes continuous ownership during marriage.

### Section 301 - Optional Enhancements

**Priority 1: Add §312 E&P calculation**
```lean
structure EarningsAndProfits where
  current_year_ep : Currency
  accumulated_ep : Currency

def calculateDividendPortion (d : Distribution) (ep : EarningsAndProfits) : Currency := ...
```

**Priority 2: Implement §318 constructive ownership**
```lean
structure Shareholder where
  direct_ownership_percent : Nat
  family_attributed_percent : Nat
  entity_attributed_percent : Nat

def totalOwnership (s : Shareholder) : Nat := ...
```

---

## Conclusion

### Summary Scores

| Section | Score | Status | Proofs | Usability | Legal Accuracy |
|---------|-------|--------|--------|-----------|----------------|
| 108 | 7/10 | GOOD | ✓ Complete | ⚠️ Limited | ⚠️ One logic error |
| 121 | 8/10 | GOOD | ✓ Complete | ✓ High | ✓ Accurate |
| 301 | 9/10 | EXCELLENT | ✓ Complete | ✓ Very High | ✓ Accurate |

### Overall Assessment

These Lean 4 formalizations demonstrate **high-quality formal verification work**. All theorems are proven without `sorry`, indicating complete formal proofs of stated properties. The mathematical foundations are sound.

**Section 301** is production-ready for its covered provisions and can be used immediately for corporate distribution analysis.

**Section 121** is highly usable for standard principal residence sales and correctly implements the complex nonqualified use calculations. The missing reduced exclusion provisions limit its applicability to edge cases but don't affect correctness for standard scenarios.

**Section 108** correctly implements core discharge and attribute reduction mechanics but has one critical logic error in the QualifiedRealPropertyBusiness category and lacks several important provisions. It should be fixed before production use in scenarios involving real property business debt or entity passthrough rules.

### Notable Achievements

1. **Zero `sorry` statements** across all three sections
2. **Sophisticated mathematical proofs** including rational arithmetic and list operations
3. **Strong type safety** with domain constraints (e.g., TaxYear ≥ 1913)
4. **Exact arithmetic** using arbitrary-precision integers
5. **Comprehensive examples** with verified outputs

### Critical for Users

Before using these formalizations in production:

1. **Test Section 108's QualifiedRealPropertyBusiness** against known correct scenarios
2. **Understand Section 121** doesn't handle reduced exclusions for unforeseen circumstances
3. **Provide Section 301** with correct dividend portion from external E&P calculation
4. **Document assumptions** about direct vs constructive ownership in §301(e)

The code is a strong foundation for tax law formalization and demonstrates that complex tax provisions can be successfully modeled in a proof assistant.
